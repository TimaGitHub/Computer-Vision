function RPC(t,s){this.agent=t,this.contrAgent=s||{},this._resultCallbacks={},this._resultCallbacksIndex=0,this._onMessage=this._onMessage.bind(this),this.agent.win.addEventListener("message",this._onMessage),this.pushMessagesToStack=!1,this.pushMessagesToQueue=!1,this._messagesStack=[]}RPC.prototype={invokeMethod:function(t,s,e){return s=[].concat(s),this._invokeMethod(t,s,e),this},clean:function(){this.agent.win.removeEventListener("message",this._onMessage),this.agent=void 0,this.contrAgent=void 0,this._resultCallbacks=void 0,this._resultCallbacksIndex=0},onIframeLoad:function(){(this.pushMessagesToQueue?this._messagesStack:this._messagesStack.reverse()).forEach(this._onMessage),this._messagesStack=[],this.pushMessagesToStack=!1,this.pushMessagesToQueue=!1},_onMessage:function(t){if(!this.contrAgent||!this.contrAgent.win||t.source!==this.contrAgent.win)return void((this.pushMessagesToStack||this.pushMessagesToQueue)&&this._messagesStack.push(t));let s,e=t.data;try{e=JSON.parse(e)}catch(t){return}if(e.methodCall){if(this.contrAgent.url||(this.contrAgent.url=t.origin),this.agent[e.methodCall]){let t,a=e.params;s=e.resultCallbackIndex?this._deInstrumentCallback(e.resultCallbackIndex):[],e.paramsCallbackIndex&&(a=[].concat(a,this._deInstrumentCallback(e.paramsCallbackIndex))),t=this.agent[e.methodCall].apply(this.agent,[].concat(a)),e.resultCallbackIndex&&s(t)}}else e.returnCall&&(s=this._idObjToCallback(e.resultCallbackIndex),s&&s.apply(this.agent,[].concat(e.params)))},_invokeCallback:function(t,s){this._invokeMethod("",s,t)},_callbackToIdObj:function(t){let s=++this._resultCallbacksIndex;return this._resultCallbacks[s]=t,{__callbackId:s}},_idObjToCallback:function(t){let s=t,e=this._resultCallbacks[s];return delete this._resultCallbacks[s],e},_instrumentCallback:function(t){return this._callbackToIdObj(t)},_deInstrumentCallback:function(t){return function(){setTimeout(function(s){this.contrAgent&&this._invokeCallback(t.__callbackId,[].slice.call(s))}.bind(this,arguments),0)}.bind(this)},_invokeMethod:function(t,s,e){let a;if(t){let n,l=s&&s.pop();"function"==typeof l?n=this._instrumentCallback(l):s&&s.push(l),a={methodCall:t,params:s,paramsCallbackIndex:n,resultCallbackIndex:e&&this._instrumentCallback(e)}}else a={returnCall:!0,params:s,resultCallbackIndex:e};a=JSON.stringify(a),this.contrAgent.win.postMessage(a,this.contrAgent.url)}};